<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Achronyme SDK v2.0 - Basic Test</title>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        h1 {
            color: #4ec9b0;
            border-bottom: 2px solid #4ec9b0;
            padding-bottom: 10px;
        }

        h2 {
            color: #569cd6;
            margin-top: 30px;
        }

        .test-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        button:hover {
            background: #1177bb;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .results {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .success {
            color: #4ec9b0;
        }

        .error {
            color: #f48771;
        }

        .info {
            color: #569cd6;
        }

        .warning {
            color: #ce9178;
        }

        .stat {
            display: inline-block;
            margin: 10px 20px 10px 0;
        }

        .stat-label {
            color: #858585;
            font-size: 12px;
        }

        .stat-value {
            color: #4ec9b0;
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üöÄ Achronyme SDK v2.0 - Basic Tests</h1>

    <!-- Test 1: Initialization -->
    <div class="test-section">
        <h2>1Ô∏è‚É£ Initialization Test</h2>
        <button onclick="testInit()">Run Test</button>
        <div id="init-results" class="results"></div>
    </div>

    <!-- Test 2: Vector Creation -->
    <div class="test-section">
        <h2>2Ô∏è‚É£ Vector Creation & Zero-Copy Test</h2>
        <button onclick="testVectors()">Run Test</button>
        <div id="vector-results" class="results"></div>
    </div>

    <!-- Test 3: Math Operations -->
    <div class="test-section">
        <h2>3Ô∏è‚É£ Math Operations Test</h2>
        <button onclick="testMathOps()">Run Test</button>
        <div id="math-results" class="results"></div>
    </div>

    <!-- Test 4: DSP Operations -->
    <div class="test-section">
        <h2>4Ô∏è‚É£ DSP Operations Test</h2>
        <button onclick="testDSPOps()">Run Test</button>
        <div id="dsp-results" class="results"></div>
    </div>

    <!-- Test 5: Memory Management -->
    <div class="test-section">
        <h2>5Ô∏è‚É£ Memory Management Test</h2>
        <button onclick="testMemory()">Run Test</button>
        <div id="memory-results" class="results"></div>
    </div>

    <!-- Test 6: Session-Based API -->
    <div class="test-section">
        <h2>6Ô∏è‚É£ Session-Based API Test</h2>
        <button onclick="testSession()">Run Test</button>
        <div id="session-results" class="results"></div>
    </div>

    <!-- Run All Tests -->
    <div class="test-section">
        <h2>üéØ Run All Tests</h2>
        <button onclick="runAllTests()">Run All Tests</button>
    </div>

    <script type="module">
        // Import SDK v2
        import { Achronyme } from '../src/sdk/index.ts';

        // Global instance
        let ach = null;

        // Initialize Achronyme
        window.testInit = async function() {
            const resultsDiv = document.getElementById('init-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Initializing Achronyme SDK v2.0...</span>';

            try {
                const start = performance.now();
                ach = new Achronyme();
                await ach.init();
                const end = performance.now();

                resultsDiv.innerHTML = `
<span class="success">‚úÖ Initialization successful!</span>
Time: ${(end - start).toFixed(2)}ms

<span class="info">SDK Version:</span> 2.0.0
<span class="info">Backend:</span> Rust WASM
<span class="info">Status:</span> Ready
                `.trim();
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Initialization failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Test vector creation and zero-copy
        window.testVectors = async function() {
            const resultsDiv = document.getElementById('vector-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Testing vector creation...</span>';

            if (!ach) {
                resultsDiv.innerHTML = '<span class="error">‚ùå Please initialize SDK first!</span>';
                return;
            }

            try {
                // Create vector
                const start1 = performance.now();
                const v = ach.vector([1, 2, 3, 4, 5]);
                const end1 = performance.now();

                // Zero-copy view
                const start2 = performance.now();
                const view = v.data;
                const end2 = performance.now();

                // Explicit copy
                const start3 = performance.now();
                const arr = v.toArray();
                const end3 = performance.now();

                resultsDiv.innerHTML = `
<span class="success">‚úÖ Vector creation successful!</span>

<span class="info">Creation time:</span> ${(end1 - start1).toFixed(3)}ms
<span class="info">Zero-copy view:</span> ${(end2 - start2).toFixed(3)}ms ‚ö°
<span class="info">Explicit copy:</span> ${(end3 - start3).toFixed(3)}ms

<span class="info">Vector length:</span> ${v.length}
<span class="info">View type:</span> ${view.constructor.name}
<span class="info">View data:</span> [${Array.from(view).join(', ')}]
<span class="info">Array data:</span> [${arr.join(', ')}]
                `.trim();
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Test math operations
        window.testMathOps = async function() {
            const resultsDiv = document.getElementById('math-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Testing math operations...</span>';

            if (!ach) {
                resultsDiv.innerHTML = '<span class="error">‚ùå Please initialize SDK first!</span>';
                return;
            }

            try {
                await ach.use(async () => {
                    const v = ach.vector([0, Math.PI/4, Math.PI/2, Math.PI]);

                    const start = performance.now();
                    const sinV = ach.sin(v);
                    const cosV = ach.cos(v);
                    const expV = ach.exp(ach.vector([0, 1, 2, 3]));
                    const end = performance.now();

                    resultsDiv.innerHTML = `
<span class="success">‚úÖ Math operations successful!</span>

<span class="info">Total time:</span> ${(end - start).toFixed(3)}ms

<span class="info">Input:</span> [0, œÄ/4, œÄ/2, œÄ]
<span class="info">sin(v):</span> [${Array.from(sinV.data).map(x => x.toFixed(4)).join(', ')}]
<span class="info">cos(v):</span> [${Array.from(cosV.data).map(x => x.toFixed(4)).join(', ')}]

<span class="info">exp([0,1,2,3]):</span> [${Array.from(expV.data).map(x => x.toFixed(4)).join(', ')}]
                    `.trim();
                });
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Test DSP operations
        window.testDSPOps = async function() {
            const resultsDiv = document.getElementById('dsp-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Testing DSP operations...</span>';

            if (!ach) {
                resultsDiv.innerHTML = '<span class="error">‚ùå Please initialize SDK first!</span>';
                return;
            }

            try {
                await ach.use(async () => {
                    // Create signal
                    const n = 1024;
                    const t = ach.linspace(0, 1, n);
                    const signal = ach.map(x => Math.sin(2 * Math.PI * 10 * x), t);

                    // FFT
                    const start1 = performance.now();
                    const spectrum = ach.fft(signal);
                    const end1 = performance.now();

                    // Magnitude
                    const start2 = performance.now();
                    const magnitudes = ach.fftMag(signal);
                    const end2 = performance.now();

                    // Window function
                    const start3 = performance.now();
                    const window = ach.dsp.hanning(n);
                    const end3 = performance.now();

                    resultsDiv.innerHTML = `
<span class="success">‚úÖ DSP operations successful!</span>

<span class="info">Signal length:</span> ${n}
<span class="info">FFT time:</span> ${(end1 - start1).toFixed(3)}ms
<span class="info">Magnitude time:</span> ${(end2 - start2).toFixed(3)}ms
<span class="info">Window generation:</span> ${(end3 - start3).toFixed(3)}ms

<span class="info">Spectrum size:</span> ${spectrum.rows} x ${spectrum.cols}
<span class="info">Magnitudes length:</span> ${magnitudes.length}
<span class="info">Window length:</span> ${window.length}

<span class="info">First 5 magnitudes:</span> [${Array.from(magnitudes.data.slice(0, 5)).map(x => x.toFixed(4)).join(', ')}]
                    `.trim();
                });
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Test memory management
        window.testMemory = async function() {
            const resultsDiv = document.getElementById('memory-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Testing memory management...</span>';

            if (!ach) {
                resultsDiv.innerHTML = '<span class="error">‚ùå Please initialize SDK first!</span>';
                return;
            }

            try {
                // Get initial stats
                const initialStats = ach.getMemoryStats();

                // Create many values in session
                await ach.use(async () => {
                    for (let i = 0; i < 100; i++) {
                        ach.vector([...Array(1000).keys()]);
                    }
                });

                // Get final stats
                const finalStats = ach.getMemoryStats();

                // Force GC
                const cleaned = ach.gc();

                resultsDiv.innerHTML = `
<span class="success">‚úÖ Memory management test complete!</span>

<span class="info">Before session:</span>
  Allocated: ${initialStats.allocated}
  Freed: ${initialStats.freed}
  Active: ${initialStats.active}
  Leaked: ${initialStats.leaked}

<span class="info">After session + cleanup:</span>
  Allocated: ${finalStats.allocated}
  Freed: ${finalStats.freed}
  Active: ${finalStats.active}
  Leaked: ${finalStats.leaked} ${finalStats.leaked === 0 ? '‚úÖ' : '‚ùå'}

<span class="info">Force GC cleaned:</span> ${cleaned} handles

<span class="success">‚úÖ No memory leaks detected!</span>
                `.trim();
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Test session-based API
        window.testSession = async function() {
            const resultsDiv = document.getElementById('session-results');
            resultsDiv.innerHTML = '<span class="info">‚è≥ Testing session-based API...</span>';

            if (!ach) {
                resultsDiv.innerHTML = '<span class="error">‚ùå Please initialize SDK first!</span>';
                return;
            }

            try {
                let resultData = null;

                const start = performance.now();
                await ach.use(async () => {
                    const signal = ach.linspace(0, 1, 1000);
                    const processed = ach.map(x => Math.sin(2 * Math.PI * 5 * x), signal);
                    const spectrum = ach.dsp.fftMag(processed);

                    // Extract data before session ends
                    resultData = Array.from(spectrum.data.slice(0, 10));

                    // No dispose() needed - auto cleanup!
                });
                const end = performance.now();

                const stats = ach.getMemoryStats();

                resultsDiv.innerHTML = `
<span class="success">‚úÖ Session-based API test successful!</span>

<span class="info">Execution time:</span> ${(end - start).toFixed(3)}ms

<span class="info">Result preview:</span> [${resultData.map(x => x.toFixed(4)).join(', ')}...]

<span class="info">Memory after session:</span>
  Active handles: ${stats.active}
  Leaked handles: ${stats.leaked} ${stats.leaked === 0 ? '‚úÖ' : '‚ùå'}

<span class="success">‚úÖ No dispose() calls needed - fully automatic!</span>
                `.trim();
            } catch (error) {
                resultsDiv.innerHTML = `<span class="error">‚ùå Test failed: ${error.message}</span>`;
                console.error(error);
            }
        };

        // Run all tests
        window.runAllTests = async function() {
            await testInit();
            await new Promise(r => setTimeout(r, 500));
            await testVectors();
            await new Promise(r => setTimeout(r, 500));
            await testMathOps();
            await new Promise(r => setTimeout(r, 500));
            await testDSPOps();
            await new Promise(r => setTimeout(r, 500));
            await testMemory();
            await new Promise(r => setTimeout(r, 500));
            await testSession();
        };

        // Auto-run on load
        console.log('üöÄ SDK v2.0 Test Page Loaded');
        console.log('Click "Run All Tests" to begin');
    </script>
</body>
</html>
