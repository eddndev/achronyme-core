<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rust WASM Performance Benchmark</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .status.loading {
            background: #fef3c7;
            color: #92400e;
        }

        .status.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .bench-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .bench-section h2 {
            color: #4c51bf;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        input[type="number"] {
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1em;
            width: 150px;
        }

        .results {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .comparison-table th {
            background: #f3f4f6;
            font-weight: 600;
            color: #374151;
        }

        .winner {
            color: #10b981;
            font-weight: 600;
        }

        .loser {
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° Rust WASM Performance Benchmark</h1>
        <p class="subtitle">Testing Rust WASM directly (no SDK) - Fast Path implementation</p>

        <div id="status" class="status loading">
            ‚è≥ Cargando m√≥dulo Rust WASM...
        </div>

        <div class="bench-section">
            <h2>1Ô∏è‚É£ Basic Vector Operations</h2>
            <div class="controls">
                <label>
                    Size: <input type="number" id="basic-size" value="100000" min="1000" step="1000">
                </label>
                <button onclick="benchBasicOps()">Run Benchmark</button>
            </div>
            <div id="basic-results" class="results"></div>
        </div>

        <div class="bench-section">
            <h2>2Ô∏è‚É£ FFT Performance</h2>
            <div class="controls">
                <label>
                    Size (power of 2): <input type="number" id="fft-size" value="4096" min="256" step="256">
                </label>
                <button onclick="benchFFT()">Run FFT Benchmark</button>
            </div>
            <div id="fft-results" class="results"></div>
        </div>

        <div class="bench-section">
            <h2>3Ô∏è‚É£ DSP Pipeline (linspace ‚Üí sin ‚Üí fft ‚Üí mag)</h2>
            <div class="controls">
                <label>
                    Samples: <input type="number" id="pipeline-size" value="8192" min="1024" step="1024">
                </label>
                <button onclick="benchPipeline()">Run Pipeline</button>
            </div>
            <div id="pipeline-results" class="results"></div>
        </div>

        <div class="bench-section">
            <h2>4Ô∏è‚É£ Extreme Stress Test (10M+ elements)</h2>
            <div class="controls">
                <label>
                    Size: <input type="number" id="stress-size" value="10000000" min="1000000" step="1000000">
                </label>
                <button onclick="benchStress()">Run Stress Test</button>
            </div>
            <div id="stress-results" class="results"></div>
        </div>

        <div class="bench-section">
            <h2>5Ô∏è‚É£ Fast Path vs Slow Path Comparison</h2>
            <div class="controls">
                <button onclick="benchFastVsSlow()">Compare Fast vs Slow Path</button>
            </div>
            <div id="path-results" class="results"></div>
        </div>
    </div>

    <script type="module">
        import init, {
            _eval, reset, createVector, getVector, bindVariableToHandle,
            releaseHandle,
            sin_fast, cos_fast, fft_fast, fft_mag_fast, linspace_fast,
            identity_js
        } from '../dist-rust-web/achronyme_wasm.js';

        const statusEl = document.getElementById('status');
        let Module = null;

        // Initialize WASM
        async function initWASM() {
            try {
                await init();

                // Create module object with all functions
                Module = {
                    _eval,
                    reset,
                    createVector,
                    getVector,
                    bindVariableToHandle,
                    releaseHandle,
                    sin_fast,
                    cos_fast,
                    fft_fast,
                    fft_mag_fast,
                    linspace_fast,
                    identity_js
                };

                statusEl.className = 'status success';
                statusEl.textContent = '‚úÖ Rust WASM loaded successfully - Ready for benchmarks';
                console.log('Rust WASM module initialized');
            } catch (error) {
                statusEl.className = 'status error';
                statusEl.textContent = '‚ùå Error loading WASM: ' + error.message;
                console.error(error);
            }
        }

        // Helper: Create vector using Fast Path (createVector helper)
        function createVectorFast(data) {
            // Convert Float64Array to regular array if needed
            const arr = data instanceof Float64Array ? Array.from(data) : data;
            return Module.createVector(arr);
        }

        // Benchmark 1: Basic Operations
        window.benchBasicOps = async function() {
            const size = parseInt(document.getElementById('basic-size').value);
            const resultsEl = document.getElementById('basic-results');

            try {
                resultsEl.textContent = '‚è≥ Running basic operations benchmark...\n';
                let output = '';

                output += `üìä BASIC VECTOR OPERATIONS BENCHMARK\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `Dataset size: ${size.toLocaleString()} elements\n\n`;

                // Generate test data
                const data = new Float64Array(size);
                for (let i = 0; i < size; i++) {
                    data[i] = Math.random() * 100;
                }

                // RUST WASM - Fast Path
                output += `ü¶Ä RUST WASM (Fast Path with Handles):\n`;

                const start1 = performance.now();
                const handle = createVectorFast(data);
                const createTime = performance.now() - start1;

                const start2 = performance.now();
                const sinHandle = Module.sin_fast(handle);
                const sinTime = performance.now() - start2;

                const start3 = performance.now();
                const cosHandle = Module.cos_fast(sinHandle);
                const cosTime = performance.now() - start3;

                Module.releaseHandle(handle);
                Module.releaseHandle(sinHandle);
                Module.releaseHandle(cosHandle);

                const totalRust = createTime + sinTime + cosTime;

                output += `   Create vector: ${createTime.toFixed(2)}ms\n`;
                output += `   sin():         ${sinTime.toFixed(2)}ms\n`;
                output += `   cos():         ${cosTime.toFixed(2)}ms\n`;
                output += `   TOTAL:         ${totalRust.toFixed(2)}ms\n\n`;

                // JavaScript Native
                output += `üìú JavaScript Native:\n`;

                const start4 = performance.now();
                const jsData = Array.from(data);
                const start5 = performance.now();
                const jsSin = jsData.map(Math.sin);
                const jsSinTime = performance.now() - start5;
                const start6 = performance.now();
                const jsCos = jsSin.map(Math.cos);
                const jsCosTime = performance.now() - start6;
                const totalJS = performance.now() - start4;

                output += `   sin():         ${jsSinTime.toFixed(2)}ms\n`;
                output += `   cos():         ${jsCosTime.toFixed(2)}ms\n`;
                output += `   TOTAL:         ${totalJS.toFixed(2)}ms\n\n`;

                // Comparison
                const speedup = (totalJS / totalRust).toFixed(2);
                output += `üìà PERFORMANCE COMPARISON:\n`;
                output += `   Speedup: ${speedup}x ${speedup > 1 ? 'üöÄ RUST WINS!' : '‚ö° JS WINS!'}\n`;
                output += `   Rust is ${((speedup - 1) * 100).toFixed(1)}% ${speedup > 1 ? 'faster' : 'slower'}\n`;

                resultsEl.textContent = output;
            } catch (error) {
                console.error('Benchmark Error:', error);
                resultsEl.textContent = '‚ùå Error: ' + (error?.message || String(error)) + '\n' + (error?.stack || '');
            }
        };

        // Benchmark 2: FFT
        window.benchFFT = async function() {
            const size = parseInt(document.getElementById('fft-size').value);
            const resultsEl = document.getElementById('fft-results');

            try {
                resultsEl.textContent = '‚è≥ Running FFT benchmark...\n';
                let output = '';

                output += `üì° FFT PERFORMANCE BENCHMARK\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `FFT size: ${size.toLocaleString()} samples\n\n`;

                // Generate test signal
                const signal = new Float64Array(size);
                for (let i = 0; i < size; i++) {
                    signal[i] = Math.sin(2 * Math.PI * 10 * i / size);
                }

                // RUST WASM FFT
                output += `ü¶Ä RUST WASM FFT (Fast Path):\n`;

                const start1 = performance.now();
                const handle = createVectorFast(signal);
                const start2 = performance.now();
                const fftHandle = Module.fft_fast(handle);
                const fftTime = performance.now() - start2;
                const start3 = performance.now();
                const magHandle = Module.fft_mag_fast(fftHandle);
                const magTime = performance.now() - start3;
                const totalRust = performance.now() - start1;

                Module.releaseHandle(handle);
                Module.releaseHandle(fftHandle);
                Module.releaseHandle(magHandle);

                output += `   FFT:           ${fftTime.toFixed(2)}ms\n`;
                output += `   Magnitude:     ${magTime.toFixed(2)}ms\n`;
                output += `   TOTAL:         ${totalRust.toFixed(2)}ms\n\n`;

                output += `‚úÖ FFT Benchmark Complete!\n`;
                output += `   ${size} samples processed in ${totalRust.toFixed(2)}ms\n`;
                output += `   Throughput: ${(size / totalRust * 1000).toLocaleString()} samples/sec\n`;

                resultsEl.textContent = output;
            } catch (error) {
                console.error('Benchmark Error:', error);
                resultsEl.textContent = '‚ùå Error: ' + (error?.message || String(error)) + '\n' + (error?.stack || '');
            }
        };

        // Benchmark 3: DSP Pipeline
        window.benchPipeline = async function() {
            const size = parseInt(document.getElementById('pipeline-size').value);
            const resultsEl = document.getElementById('pipeline-results');

            try {
                resultsEl.textContent = '‚è≥ Running DSP pipeline...\n';
                let output = '';

                output += `üéõÔ∏è DSP PIPELINE BENCHMARK\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `Pipeline: linspace ‚Üí sin ‚Üí fft ‚Üí magnitude\n`;
                output += `Size: ${size.toLocaleString()} samples\n\n`;

                const pipelineStart = performance.now();

                // Step 1: linspace
                const step1Start = performance.now();
                const linspaceHandle = Module.linspace_fast(0, 10, size);
                const step1Time = performance.now() - step1Start;

                // Step 2: sin
                const step2Start = performance.now();
                const sinHandle = Module.sin_fast(linspaceHandle);
                const step2Time = performance.now() - step2Start;

                // Step 3: fft
                const step3Start = performance.now();
                const fftHandle = Module.fft_fast(sinHandle);
                const step3Time = performance.now() - step3Start;

                // Step 4: magnitude
                const step4Start = performance.now();
                const magHandle = Module.fft_mag_fast(fftHandle);
                const step4Time = performance.now() - step4Start;

                const totalTime = performance.now() - pipelineStart;

                output += `üìä Pipeline Steps:\n`;
                output += `   1. linspace():  ${step1Time.toFixed(2)}ms\n`;
                output += `   2. sin():       ${step2Time.toFixed(2)}ms\n`;
                output += `   3. fft():       ${step3Time.toFixed(2)}ms\n`;
                output += `   4. magnitude(): ${step4Time.toFixed(2)}ms\n`;
                output += `   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                output += `   TOTAL:          ${totalTime.toFixed(2)}ms\n\n`;

                output += `‚ö° Performance:\n`;
                output += `   Throughput: ${(size / totalTime * 1000).toLocaleString()} samples/sec\n`;
                output += `   All operations used Fast Path (handles only)\n`;
                output += `   Zero serialization overhead\n`;

                // Cleanup
                Module.releaseHandle(linspaceHandle);
                Module.releaseHandle(sinHandle);
                Module.releaseHandle(fftHandle);
                Module.releaseHandle(magHandle);

                resultsEl.textContent = output;
            } catch (error) {
                console.error('Benchmark Error:', error);
                resultsEl.textContent = '‚ùå Error: ' + (error?.message || String(error)) + '\n' + (error?.stack || '');
            }
        };

        // Benchmark 4: Stress Test
        window.benchStress = async function() {
            const size = parseInt(document.getElementById('stress-size').value);
            const resultsEl = document.getElementById('stress-results');

            try {
                resultsEl.textContent = '‚è≥ Running extreme stress test...\n';
                let output = '';

                output += `üí™ EXTREME STRESS TEST\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
                output += `Size: ${size.toLocaleString()} elements (${(size * 8 / 1024 / 1024).toFixed(1)}MB)\n\n`;

                // Generate huge dataset
                output += `Generating ${size.toLocaleString()} random numbers...\n`;
                const genStart = performance.now();
                const huge = new Float64Array(size);
                for (let i = 0; i < size; i++) {
                    huge[i] = Math.random() * 100;
                }
                const genTime = performance.now() - genStart;
                output += `Generated in ${genTime.toFixed(2)}ms\n\n`;

                // Create vector (Fast Path)
                output += `Creating WASM vector (Fast Path)...\n`;
                const createStart = performance.now();
                const handle = createVectorFast(huge);
                const createTime = performance.now() - createStart;
                output += `Created in ${createTime.toFixed(2)}ms\n`;
                output += `Bandwidth: ${(size * 8 / createTime / 1024).toFixed(2)} MB/s\n\n`;

                // Operations
                output += `Running operations...\n`;
                const opStart = performance.now();
                const h2 = Module.sin_fast(handle);
                const sinTime = performance.now() - opStart;
                output += `sin(): ${sinTime.toFixed(2)}ms\n`;

                const cosStart = performance.now();
                const h3 = Module.cos_fast(h2);
                const cosTime = performance.now() - cosStart;
                output += `cos(): ${cosTime.toFixed(2)}ms\n\n`;

                const totalOps = sinTime + cosTime;

                output += `üìä RESULTS:\n`;
                output += `   Total operations time: ${totalOps.toFixed(2)}ms\n`;
                output += `   Throughput: ${(size / totalOps * 1000).toLocaleString()} elements/sec\n`;
                output += `   Memory usage: ${(size * 8 / 1024 / 1024).toFixed(1)}MB in WASM heap\n`;
                output += `\n‚úÖ Successfully processed ${size.toLocaleString()} elements!\n`;

                // Cleanup
                Module.releaseHandle(handle);
                Module.releaseHandle(h2);
                Module.releaseHandle(h3);

                resultsEl.textContent = output;
            } catch (error) {
                console.error('Benchmark Error:', error);
                resultsEl.textContent = '‚ùå Error: ' + (error?.message || String(error)) + '\n' + (error?.stack || '');
            }
        };

        // Benchmark 5: Fast vs Slow Path
        window.benchFastVsSlow = async function() {
            const resultsEl = document.getElementById('path-results');

            try {
                resultsEl.textContent = '‚è≥ Comparing Fast Path vs Slow Path...\n';
                let output = '';

                output += `‚ö° FAST PATH vs SLOW PATH COMPARISON\n`;
                output += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;

                const sizes = [10, 100, 1000, 10000, 100000];

                for (const size of sizes) {
                    output += `Size: ${size.toLocaleString()} elements\n`;

                    const data = new Float64Array(size);
                    for (let i = 0; i < size; i++) data[i] = i;

                    // FAST PATH
                    const fastStart = performance.now();
                    const handle = createVectorFast(data);
                    const sinHandle = Module.sin_fast(handle);
                    Module.releaseHandle(handle);
                    Module.releaseHandle(sinHandle);
                    const fastTime = performance.now() - fastStart;

                    // SLOW PATH (usando eval)
                    const slowStart = performance.now();
                    const expr = `sin([${Array.from(data).join(',')}])`;
                    const result = Module._eval(expr);
                    const slowTime = performance.now() - slowStart;

                    const speedup = (slowTime / fastTime).toFixed(2);
                    output += `   Fast Path: ${fastTime.toFixed(2)}ms\n`;
                    output += `   Slow Path: ${slowTime.toFixed(2)}ms\n`;
                    output += `   Speedup: ${speedup}x ${speedup > 10 ? 'üöÄ' : '‚ö°'}\n\n`;
                }

                output += `‚úÖ Fast Path is consistently faster, especially for larger datasets\n`;

                resultsEl.textContent = output;
            } catch (error) {
                console.error('Benchmark Error:', error);
                resultsEl.textContent = '‚ùå Error: ' + (error?.message || String(error)) + '\n' + (error?.stack || '');
            }
        };

        // Initialize on load
        initWASM();
    </script>
</body>
</html>
